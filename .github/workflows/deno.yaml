---
name: Build
# This workflow will install Deno then run `deno fmt`, `deno lint`, and `deno test`.
# For more information see: https://github.com/denoland/setup-deno

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
  merge_group:
  schedule:
    - cron: "0 14 * * 1" # every monday at 9 in the morning CST
  workflow_dispatch:

permissions:
  contents: read # Needed to clone the repository

env:
  CI: true
  DENO_VERSION: v1.39.x

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    permissions:
      id-token: write # Needed for auth with Deno Deploy
      pull-requests: write # Needed for biome comments

    steps:
      - name: ğŸ“š Git checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          submodules: recursive
          clean: true
          persist-credentials: false
          set-safe-directory: true

      - name: ğŸ¦• Install Deno
        uses: denoland/setup-deno@041b854f97b325bd60e53e9dc2de9cb9f9ac0cba # v1.1.4
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: âš™ï¸ Cache Deno dependencies
        uses: actions/cache@13aacd865c20de90d75de3b17ebe84f7a17d57d2 # v4.0.0
        with:
          path: node_modules/
          key: deno_cache-${{ runner.arch }}-${{ runner.os }}-${{ hashFiles('deno.json') }}
          restore-keys: deno_cache-${{ runner.arch }}-${{ runner.os }}

      - name: ğŸ“¦ Install dependencies
        run: deno cache src/main.ts

      - name: ğŸ•µï¸ Run linter, verify formatting, typecheck
        run: deno task ci

      - name: ğŸ§ª Run tests
        run: deno task test

      - name: ğŸ”¨ Build
        run: deno task build

      - name: ğŸ“Š Collect coverage
        run: deno task test:coverage

      - name: ğŸ”§ Upload to Deno Deploy
        uses: denoland/deployctl@f21311b48f62f0063e3c729fc8a6a5dcdc4da7f9 # 1.10.3
        with:
          project: "why-switch"
          entrypoint: src/main.ts
          include: |
            src
            deno.json
